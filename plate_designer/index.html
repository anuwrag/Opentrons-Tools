<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Labware Viewer</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #labwareCanvas {
            border: 1px solid #ccc;
            margin-top: 20px;
            margin-left: 30px;  /* Add margin for row labels */
        }
        .container {
            padding: 20px;
        }
        #fileInput {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <h2 class="mb-4">Labware Viewer</h2>
                
                <!-- File input button styled with Bootstrap -->
                <label for="fileInput" class="btn btn-primary mb-3">
                    Load Labware JSON Files
                </label>
                <input type="file" id="fileInput" multiple accept=".json">
                
                <select id="labwareSelect" class="form-select mb-3">
                    <option value="">Select Labware</option>
                </select>
                
                <canvas id="labwareCanvas"></canvas>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Store loaded JSON data
        const labwareData = {};
        
        // Get DOM elements
        const fileInput = document.getElementById('fileInput');
        const labwareSelect = document.getElementById('labwareSelect');
        const canvas = document.getElementById('labwareCanvas');
        const ctx = canvas.getContext('2d');

        // Scale factor for drawing (mm to pixels)
        const SCALE_FACTOR = 5;
        
        // Handle file selection
        fileInput.addEventListener('change', async (event) => {
            // Clear previous options except the default one
            labwareSelect.innerHTML = '<option value="">Select Labware</option>';
            
            // Process each selected file
            for (const file of event.target.files) {
                if (file.name.endsWith('.json')) {
                    try {
                        const text = await file.text();
                        const data = JSON.parse(text);
                        
                        // Store the data
                        labwareData[file.name] = data;
                        
                        // Add option to select
                        const option = document.createElement('option');
                        option.value = file.name;
                        option.textContent = data.metadata.displayName || file.name;
                        labwareSelect.appendChild(option);
                    } catch (error) {
                        console.error(`Error loading ${file.name}:`, error);
                    }
                }
            }
        });

        // Function to draw labware
        function drawLabware(data) {
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Add padding for labels
            const LABEL_PADDING = 30;
            
            // Set canvas size based on labware dimensions plus padding
            canvas.width = data.dimensions.xDimension * SCALE_FACTOR + LABEL_PADDING;
            canvas.height = data.dimensions.yDimension * SCALE_FACTOR + LABEL_PADDING;
            
            // Draw plate outline with rounded corners
            ctx.beginPath();
            const radius = 10;
            ctx.roundRect(
                LABEL_PADDING, LABEL_PADDING,
                data.dimensions.xDimension * SCALE_FACTOR,
                data.dimensions.yDimension * SCALE_FACTOR,
                radius
            );
            ctx.strokeStyle = '#000';
            ctx.stroke();
            
            // Get unique column and row numbers/letters
            const wells = Object.keys(data.wells);
            const columns = [...new Set(wells.map(well => well.match(/\d+/)[0]))];
            const rows = [...new Set(wells.map(well => well.match(/[A-Z]+/)[0]))];
            
            // Draw column numbers
            ctx.fillStyle = '#000';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            columns.forEach(col => {
                const firstWellInCol = wells.find(well => well.endsWith(col));
                const x = (data.wells[firstWellInCol].x * SCALE_FACTOR) + LABEL_PADDING;
                ctx.fillText(col, x, LABEL_PADDING - 10);
            });
            
            // Draw row letters
            ctx.textAlign = 'right';
            rows.forEach(row => {
                const firstWellInRow = wells.find(well => well.startsWith(row));
                const y = (data.wells[firstWellInRow].y * SCALE_FACTOR) + LABEL_PADDING;
                ctx.fillText(row, LABEL_PADDING - 5, y + 4);
            });
            
            // Draw wells
            for (const [wellId, well] of Object.entries(data.wells)) {
                const x = well.x * SCALE_FACTOR + LABEL_PADDING;
                const y = well.y * SCALE_FACTOR + LABEL_PADDING;
                
                ctx.beginPath();
                if (well.shape === 'rectangular') {
                    const width = well.xDimension * SCALE_FACTOR;
                    const height = well.yDimension * SCALE_FACTOR;
                    ctx.rect(x - width/2, y - height/2, width, height);
                } else if (well.shape === 'circular') {
                    const radius = (well.diameter * SCALE_FACTOR) / 2;
                    ctx.arc(x, y, radius, 0, 2 * Math.PI);
                }
                ctx.strokeStyle = '#666';
                ctx.stroke();
            }
        }

        // Handle labware selection
        labwareSelect.addEventListener('change', (event) => {
            const selectedFile = event.target.value;
            if (selectedFile && labwareData[selectedFile]) {
                drawLabware(labwareData[selectedFile]);
            }
        });
    </script>
</body>
</html>

